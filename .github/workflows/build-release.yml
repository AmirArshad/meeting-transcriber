name: Build & Release Installer

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger from GitHub UI

permissions:
  contents: write  # Required to create releases

jobs:
  build-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11.9'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Node dependencies
      run: npm install

    - name: Install electron-builder
      run: npm install electron-builder --save-dev

    - name: Create placeholder icon (if missing)
      shell: pwsh
      run: |
        # Ensure build directory exists
        if (-not (Test-Path "build")) {
          New-Item -ItemType Directory -Path "build" | Out-Null
        }

        if (-not (Test-Path "build/icon.ico")) {
          Write-Host "Creating placeholder icon..."
          # Download a placeholder microphone icon
          $url = "https://raw.githubusercontent.com/icons8/flat-color-icons/master/png/256/microphone.png"
          $png = "build/temp.png"

          try {
            Invoke-WebRequest -Uri $url -OutFile $png -ErrorAction Stop

            # Convert PNG to ICO using PowerShell
            Add-Type -AssemblyName System.Drawing
            $img = [System.Drawing.Image]::FromFile((Resolve-Path $png))
            $icon = [System.Drawing.Icon]::FromHandle($img.GetHicon())
            $stream = [System.IO.File]::Create("build/icon.ico")
            $icon.Save($stream)
            $stream.Close()
            $img.Dispose()

            Remove-Item $png
            Write-Host "Placeholder icon created!"
          } catch {
            Write-Host "Could not create icon, using fallback..."
            # Create a minimal 1x1 ICO as absolute fallback
            $bytes = @(0,0,1,0,1,0,16,16,0,0,1,0,32,0,104,4,0,0,22,0,0,0)
            [System.IO.File]::WriteAllBytes("build/icon.ico", $bytes)
          }
        }

    - name: Prepare build resources
      run: npm run prebuild
      timeout-minutes: 30

    - name: Build installer
      run: npm run build
      timeout-minutes: 20

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        else
          echo "version=dev-build" >> $GITHUB_OUTPUT
        fi

    - name: Find installer file
      id: find_installer
      shell: pwsh
      run: |
        $installer = Get-ChildItem -Path "dist" -Filter "*.exe" | Select-Object -First 1
        if ($installer) {
          echo "installer_path=$($installer.FullName)" >> $env:GITHUB_OUTPUT
          echo "installer_name=$($installer.Name)" >> $env:GITHUB_OUTPUT
          $size = [math]::Round($installer.Length / 1MB, 2)
          echo "installer_size=$size MB" >> $env:GITHUB_OUTPUT
        }

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: meeting-transcriber-installer
        path: ${{ steps.find_installer.outputs.installer_path }}
        retention-days: 30

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ steps.find_installer.outputs.installer_path }}
        body: |
          ## Meeting Transcriber v${{ steps.get_version.outputs.version }}

          ### ðŸ“¦ Installation

          1. Download `${{ steps.find_installer.outputs.installer_name }}`
          2. Run the installer
          3. Launch from Start Menu

          ### ðŸ“Š Build Info

          - **Installer Size:** ${{ steps.find_installer.outputs.installer_size }}
          - **Platform:** Windows 10/11 (64-bit)
          - **Python:** 3.11.9 (embedded)
          - **Electron:** 28.0

          ### âœ¨ Features

          - Dual audio capture (mic + desktop)
          - AI transcription (99 languages)
          - GPU acceleration support
          - Meeting history with playback
          - 100% local processing

          ### ðŸ”’ Security

          - No telemetry or tracking
          - All processing happens locally
          - See [Security Audit](https://github.com/${{ github.repository }}/blob/master/docs/internal/SECURITY_AUDIT.md)

          ---

          **First run:** Whisper model (~500MB) downloads automatically on first transcription.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
